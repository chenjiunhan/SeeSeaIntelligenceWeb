<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>SeeSea å…¨çƒèˆªé‹åœ°åœ–</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <script src="/config.js"></script>
    <style>
        html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        body { margin: 0 !important; padding: 0 !important; width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; display: block; }
        #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; }

        .stats-panel {
            position: absolute; top: 80px; left: 30px; width: 360px;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px);
            color: white; padding: 24px; border-radius: 16px; z-index: 1000;
            border: 1px solid rgba(6, 182, 212, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            cursor: move;
            user-select: none;
        }

        .stats-panel h3 {
            color: #06b6d4; margin: 0 0 20px 0; font-size: 20px;
            display: flex; align-items: center; gap: 10px;
        }

        .chokepoint-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .chokepoint-btn {
            padding: 10px 12px;
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 8px; color: #94a3b8;
            cursor: pointer; transition: all 0.3s;
            font-size: 12px; text-align: center;
            white-space: nowrap;
        }

        .chokepoint-btn:hover {
            background: rgba(6, 182, 212, 0.2);
            border-color: rgba(6, 182, 212, 0.5);
            color: #06b6d4;
        }

        .chokepoint-btn.active {
            background: rgba(6, 182, 212, 0.3);
            border-color: #06b6d4;
            color: #06b6d4;
            font-weight: 600;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
        }

        .date-range-selector {
            margin-bottom: 16px;
            padding: 16px;
            background: rgba(6, 182, 212, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        .date-range-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 8px;
            display: block;
        }

        .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .date-input-group label {
            font-size: 11px;
            color: #64748b;
        }

        .date-inputs input {
            padding: 8px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 6px;
            color: #06b6d4;
            font-size: 12px;
            font-family: monospace;
        }

        .date-inputs input:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .apply-btn {
            width: 100%;
            padding: 8px;
            background: rgba(6, 182, 212, 0.2);
            border: 1px solid rgba(6, 182, 212, 0.5);
            border-radius: 6px;
            color: #06b6d4;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .apply-btn:hover {
            background: rgba(6, 182, 212, 0.3);
            border-color: #06b6d4;
        }

        .date-info {
            font-size: 13px; color: #94a3b8; margin-bottom: 20px;
            padding: 10px; background: rgba(6, 182, 212, 0.1);
            border-radius: 8px; border-left: 3px solid #06b6d4;
        }

        .stat-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .stat-row:last-child { border-bottom: none; }

        .stat-label {
            font-size: 14px; color: #94a3b8;
            display: flex; align-items: center; gap: 8px;
        }

        .stat-value {
            font-size: 18px; font-weight: 600; color: #06b6d4;
        }

        .vessel-types {
            margin-top: 16px; padding-top: 16px;
            border-top: 1px solid rgba(148, 163, 184, 0.2);
        }

        .vessel-type {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; font-size: 13px;
        }

        .vessel-type-label { color: #cbd5e1; }
        .vessel-type-value { color: #10b981; font-weight: 600; }

        .chokepoint-label {
            background: rgba(15, 23, 42, 0.95);
            border: 2px solid #06b6d4;
            border-radius: 8px;
            padding: 8px 16px;
            color: #06b6d4;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
            white-space: nowrap;
        }

        .loading { color: #06b6d4; }
        .error { color: #ef4444; }
        .success { color: #10b981; }

        /* AI å°è©±æ¡†æ¨£å¼ */
        .ai-chat-box {
            position: fixed;
            right: 30px;
            bottom: 30px;
            width: 400px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(6, 182, 212, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }

        .ai-chat-box.minimized {
            height: auto;
        }

        .ai-chat-header {
            padding: 16px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px 16px 0 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
        }

        .ai-chat-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #06b6d4;
            font-weight: 600;
            font-size: 16px;
        }

        .ai-chat-controls {
            display: flex;
            gap: 8px;
        }

        .ai-chat-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-chat-btn:hover {
            background: rgba(148, 163, 184, 0.2);
            color: #06b6d4;
        }

        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            max-height: 400px;
            min-height: 300px;
        }

        .ai-message {
            margin-bottom: 16px;
            display: flex;
            gap: 10px;
        }

        .ai-message.user {
            flex-direction: row-reverse;
        }

        .ai-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(6, 182, 212, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .ai-message-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
        }

        .ai-message.ai .ai-message-bubble {
            background: rgba(30, 41, 59, 0.8);
            color: #e2e8f0;
        }

        .ai-message.user .ai-message-bubble {
            background: rgba(6, 182, 212, 0.3);
            color: #ffffff;
        }

        .ai-chat-input {
            padding: 16px;
            border-top: 1px solid rgba(148, 163, 184, 0.2);
            display: flex;
            gap: 8px;
        }

        .ai-chat-input input {
            flex: 1;
            padding: 12px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
        }

        .ai-chat-input input:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .ai-chat-input button {
            padding: 12px 20px;
            background: #06b6d4;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ai-chat-input button:hover {
            background: #0891b2;
        }
    </style>
</head>
<body>
    <div class="stats-panel" id="stats-panel">
        <h3 id="panel-title">ğŸŒŠ èˆªé‹æ•¸æ“š</h3>

        <div class="chokepoint-selector">
            <button class="chokepoint-btn active" data-chokepoint="suez-canal">
                ğŸ‡ªğŸ‡¬ è˜‡ä¼Šå£«é‹æ²³
            </button>
            <button class="chokepoint-btn" data-chokepoint="panama-canal">
                ğŸ‡µğŸ‡¦ å·´æ‹¿é¦¬é‹æ²³
            </button>
            <button class="chokepoint-btn" data-chokepoint="strait-of-malacca">
                ğŸ‡²ğŸ‡¾ éº»å…­ç”²æµ·å³½
            </button>
            <button class="chokepoint-btn" data-chokepoint="strait-of-hormuz">
                ğŸ‡®ğŸ‡· è·è«èŒ²æµ·å³½
            </button>
            <button class="chokepoint-btn" data-chokepoint="bab-el-mandeb">
                ğŸ‡¾ğŸ‡ª æ›¼å¾·æµ·å³½
            </button>
            <button class="chokepoint-btn" data-chokepoint="bosporus-strait">
                ğŸ‡¹ğŸ‡· åšæ–¯æ™®é­¯æ–¯
            </button>
        </div>

        <div class="date-range-selector">
            <span class="date-range-label">ğŸ“… é¸æ“‡æ—¥æœŸç¯„åœ</span>
            <div class="date-inputs">
                <div class="date-input-group">
                    <label>é–‹å§‹æ—¥æœŸ</label>
                    <input type="date" id="start-date" value="2026-01-01">
                </div>
                <div class="date-input-group">
                    <label>çµæŸæ—¥æœŸ</label>
                    <input type="date" id="end-date" value="2026-02-07">
                </div>
            </div>
            <button class="apply-btn" onclick="applyDateRange()">ğŸ” æŸ¥è©¢</button>
        </div>

        <div class="date-info" id="date-info">è«‹é¸æ“‡èˆªé“èˆ‡æ—¥æœŸç¯„åœ...</div>
        <div id="stats-content">
            <div class="stat-row">
                <span class="stat-label">ğŸ“Š ç¸½èˆ¹èˆ¶æ•¸</span>
                <span class="stat-value" id="vessel-count">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">ğŸ“ˆ å¹³å‡æ¯æ—¥</span>
                <span class="stat-value" id="avg-daily">--</span>
            </div>
            <div class="vessel-types" id="vessel-types"></div>
        </div>
        <div style="margin-top: 16px; font-size: 11px; color: #64748b; text-align: center;" id="status">
            è³‡æ–™ä¾†æº: Go API
        </div>
    </div>

    <div id="map"></div>

    <!-- AI å°è©±æ¡† -->
    <div class="ai-chat-box" id="ai-chat-box">
        <div class="ai-chat-header" id="ai-chat-header">
            <div class="ai-chat-title">
                <span>ğŸ¤–</span>
                <span>AI èˆªé‹åŠ©æ‰‹</span>
            </div>
            <div class="ai-chat-controls">
                <button class="ai-chat-btn" onclick="toggleChatMinimize()">â”€</button>
            </div>
        </div>
        <div class="ai-chat-messages" id="ai-chat-messages">
            <div class="ai-message ai">
                <div class="ai-message-avatar">ğŸ¤–</div>
                <div class="ai-message-bubble">
                    ğŸ‘‹ æ­¡è¿ä¾†åˆ° SeeSeaï¼æˆ‘æ˜¯ä½ çš„èˆªé‹æ™ºèƒ½åŠ©æ‰‹ã€‚<br><br>
                    ä½ å¯ä»¥å•æˆ‘ï¼š<br>
                    â€¢ ã€Œè˜‡ä¼Šå£«é‹æ²³æœ€è¿‘çš„èˆ¹èˆ¶æµé‡å¦‚ä½•ï¼Ÿã€<br>
                    â€¢ ã€Œç‚ºä»€éº¼é€™æ¢èˆªç·šé€™éº¼ç¹å¿™ï¼Ÿã€<br>
                    â€¢ ã€Œåˆ†ææœ€è¿‘ä¸€å€‹æœˆçš„è¶¨å‹¢ã€
                </div>
            </div>
        </div>
        <div class="ai-chat-input">
            <input type="text" id="ai-input" placeholder="å•æˆ‘ä»»ä½•é—œæ–¼èˆªé‹çš„å•é¡Œ..." onkeypress="handleChatKeyPress(event)">
            <button onclick="sendMessage()">ç™¼é€</button>
        </div>
    </div>

    <script>
        const token = 'pk.eyJ1IjoiamFxcTEwMTAiLCJhIjoiY21sY2QzdHppMHZ4dTNmcjRjb3dtNmpzcCJ9.SibRmPbOquDAtwbuWD7aSw';
        const GO_API_URL = window.GO_API_URL || 'http://localhost:8081';

        // Chokepoint ä½ç½®å’Œè³‡è¨Š
        const chokepoints = {
            'suez-canal': {
                lng: 32.35, lat: 30.0,
                name: 'ğŸŒŠ è˜‡ä¼Šå£«é‹æ²³',
                zoom: 8
            },
            'panama-canal': {
                lng: -79.91, lat: 9.08,
                name: 'ğŸŒŠ å·´æ‹¿é¦¬é‹æ²³',
                zoom: 9
            },
            'strait-of-malacca': {
                lng: 100.35, lat: 2.5,
                name: 'ğŸŒŠ éº»å…­ç”²æµ·å³½',
                zoom: 7
            },
            'strait-of-hormuz': {
                lng: 56.25, lat: 26.5,
                name: 'ğŸŒŠ è·è«èŒ²æµ·å³½',
                zoom: 8
            },
            'bab-el-mandeb': {
                lng: 43.3, lat: 12.6,
                name: 'ğŸŒŠ æ›¼å¾·æµ·å³½',
                zoom: 8
            },
            'bosporus-strait': {
                lng: 29.05, lat: 41.12,
                name: 'ğŸŒŠ åšæ–¯æ™®é­¯æ–¯æµ·å³½',
                zoom: 10
            }
        };

        let currentChokepoint = 'suez-canal';
        let currentMarker = null;

        // æ‹–æ‹‰åŠŸèƒ½
        let isDragging = false;
        let currentX, currentY, initialX, initialY;
        const panel = document.getElementById('stats-panel');

        panel.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);

        function dragStart(e) {
            // å¦‚æœé»æ“Šåœ¨æŒ‰éˆ•æˆ–è¼¸å…¥æ¡†ä¸Šï¼Œä¸è§¸ç™¼æ‹–æ‹‰
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') {
                return;
            }

            initialX = e.clientX - panel.offsetLeft;
            initialY = e.clientY - panel.offsetTop;
            isDragging = true;
        }

        function drag(e) {
            if (!isDragging) return;

            e.preventDefault();
            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;

            panel.style.left = currentX + 'px';
            panel.style.top = currentY + 'px';
        }

        function dragEnd() {
            isDragging = false;
        }

        // AI å°è©±æ¡†æ‹–æ‹‰åŠŸèƒ½
        const chatBox = document.getElementById('ai-chat-box');
        const chatHeader = document.getElementById('ai-chat-header');
        let chatDragging = false;
        let chatInitialX, chatInitialY;

        chatHeader.addEventListener('mousedown', chatDragStart);
        document.addEventListener('mousemove', chatDrag);
        document.addEventListener('mouseup', chatDragEnd);

        function chatDragStart(e) {
            const rect = chatBox.getBoundingClientRect();
            chatInitialX = e.clientX - rect.left;
            chatInitialY = e.clientY - rect.top;
            chatDragging = true;
        }

        function chatDrag(e) {
            if (!chatDragging) return;
            e.preventDefault();

            const x = e.clientX - chatInitialX;
            const y = e.clientY - chatInitialY;

            chatBox.style.right = 'auto';
            chatBox.style.bottom = 'auto';
            chatBox.style.left = x + 'px';
            chatBox.style.top = y + 'px';
        }

        function chatDragEnd() {
            chatDragging = false;
        }

        // AI å°è©±æ¡†æœ€å°åŒ–
        let isChatMinimized = false;
        const chatMessages = document.getElementById('ai-chat-messages');
        const chatInput = document.querySelector('.ai-chat-input');

        function toggleChatMinimize() {
            isChatMinimized = !isChatMinimized;
            if (isChatMinimized) {
                chatMessages.style.display = 'none';
                chatInput.style.display = 'none';
                chatBox.classList.add('minimized');
            } else {
                chatMessages.style.display = 'block';
                chatInput.style.display = 'flex';
                chatBox.classList.remove('minimized');
            }
        }

        // AI å°è©±åŠŸèƒ½
        const PYTHON_API_URL = window.PYTHON_API_URL || 'http://localhost:8001';

        function addMessage(content, type) {
            const messagesContainer = document.getElementById('ai-chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${type}`;

            const avatar = document.createElement('div');
            avatar.className = 'ai-message-avatar';
            avatar.textContent = type === 'ai' ? 'ğŸ¤–' : 'ğŸ‘¤';

            const bubble = document.createElement('div');
            bubble.className = 'ai-message-bubble';
            bubble.innerHTML = content.replace(/\n/g, '<br>');

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            messagesContainer.appendChild(messageDiv);

            // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return bubble;
        }

        async function sendMessage() {
            const input = document.getElementById('ai-input');
            const message = input.value.trim();

            if (!message) return;

            // æ·»åŠ ç”¨æˆ¶è¨Šæ¯
            addMessage(message, 'user');
            input.value = '';

            // å‰µå»º AI å›æ‡‰æ°£æ³¡
            const aiBubble = addMessage('æ€è€ƒä¸­...', 'ai');

            try {
                const response = await fetch(`${PYTHON_API_URL}/api/v1/chat/stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        session_id: 'user-session-' + Date.now()
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let aiContent = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data:')) {
                            const data = line.substring(5).trim();
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.content) {
                                    aiContent += parsed.content;
                                    aiBubble.innerHTML = aiContent.replace(/\n/g, '<br>');
                                }
                            } catch (e) {
                                // Ignore parse errors
                            }
                        }
                    }
                }

                if (!aiContent) {
                    aiBubble.innerHTML = 'æŠ±æ­‰ï¼Œæ²’æœ‰æ”¶åˆ°å›æ‡‰';
                }

            } catch (error) {
                console.error('Chat error:', error);
                aiBubble.innerHTML = 'âŒ é€£æ¥å¤±æ•—ï¼Œè«‹ç¢ºèª Python API æ­£åœ¨é‹è¡Œ';
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        mapboxgl.accessToken = token;
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v12',
            center: [32.35, 30.0],
            zoom: 8,
            projection: 'globe'
        });

        map.on('load', async () => {
            // åœ°çƒæ•ˆæœ
            map.setFog({
                color: 'rgb(6, 182, 212)',
                'high-color': 'rgb(2, 132, 199)',
                'horizon-blend': 0.02,
                'space-color': 'rgb(15, 23, 42)',
                'star-intensity': 0.6
            });

            // è¼‰å…¥åˆå§‹è³‡æ–™ä¸¦é¡¯ç¤ºæ¨™è¨˜
            await applyDateRange();
            updateChokePointMarker(currentChokepoint);
        });

        // æ›´æ–°åœ°åœ–ä¸Šçš„èˆªé“æ¨™è¨˜
        function updateChokePointMarker(id) {
            // ç§»é™¤èˆŠæ¨™è¨˜
            if (currentMarker) {
                currentMarker.remove();
            }

            const point = chokepoints[id];

            // å‰µå»ºæ¨™è¨˜å…ƒç´ 
            const el = document.createElement('div');
            el.className = 'chokepoint-label';
            el.textContent = point.name;

            // æ·»åŠ æ–°æ¨™è¨˜
            currentMarker = new mapboxgl.Marker(el)
                .setLngLat([point.lng, point.lat])
                .addTo(map);
        }

        // åˆ‡æ› chokepoint
        async function switchChokepoint(id) {
            if (currentChokepoint === id) return;

            currentChokepoint = id;
            const point = chokepoints[id];

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.chokepoint-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.chokepoint === id);
            });

            // æ›´æ–°åœ°åœ–æ¨™è¨˜
            updateChokePointMarker(id);

            // é£›åˆ°æ–°ä½ç½®
            map.flyTo({
                center: [point.lng, point.lat],
                zoom: point.zoom,
                duration: 2000,
                essential: true
            });

            // è¼‰å…¥è³‡æ–™
            await applyDateRange();
        }

        // ç¶å®šæŒ‰éˆ•äº‹ä»¶
        document.querySelectorAll('.chokepoint-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                switchChokepoint(btn.dataset.chokepoint);
            });
        });

        // æ‡‰ç”¨æ—¥æœŸç¯„åœæŸ¥è©¢
        async function applyDateRange() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                alert('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ');
                return;
            }

            if (startDate > endDate) {
                alert('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ');
                return;
            }

            await loadVesselData(currentChokepoint, startDate, endDate);
        }

        async function loadVesselData(chokepoint, startDate, endDate) {
            const dateInfo = document.getElementById('date-info');
            const status = document.getElementById('status');
            const panelTitle = document.getElementById('panel-title');

            try {
                dateInfo.innerHTML = '<span class="loading">ğŸ”„ è¼‰å…¥è³‡æ–™...</span>';
                panelTitle.textContent = chokepoints[chokepoint].name;

                // å–å¾—æ—¥æœŸç¯„åœè³‡æ–™
                const url = `${GO_API_URL}/api/v1/vessels/${chokepoint}?start_date=${startDate}&end_date=${endDate}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.data && data.data.length > 0) {
                    // è¨ˆç®—ç¸½æ•¸å’Œå¹³å‡å€¼
                    const totalVessels = data.data.reduce((sum, d) => sum + d.vessel_count, 0);
                    const totalContainer = data.data.reduce((sum, d) => sum + d.container, 0);
                    const totalDryBulk = data.data.reduce((sum, d) => sum + d.dry_bulk, 0);
                    const totalGeneralCargo = data.data.reduce((sum, d) => sum + d.general_cargo, 0);
                    const totalRoro = data.data.reduce((sum, d) => sum + d.roro, 0);
                    const totalTanker = data.data.reduce((sum, d) => sum + d.tanker, 0);
                    const avgDaily = (totalVessels / data.data.length).toFixed(1);

                    // æ›´æ–°æ—¥æœŸç¯„åœè³‡è¨Š
                    dateInfo.innerHTML = `
                        ğŸ“… ${startDate} ~ ${endDate}<br>
                        <small style="color:#64748b">${data.data.length} å¤©è³‡æ–™</small>
                    `;

                    // æ›´æ–°ç¸½æ•¸å’Œå¹³å‡
                    document.getElementById('vessel-count').textContent = totalVessels.toLocaleString();
                    document.getElementById('avg-daily').textContent = avgDaily;

                    // æ›´æ–°èˆ¹èˆ¶é¡å‹
                    const vesselTypes = document.getElementById('vessel-types');
                    vesselTypes.innerHTML = `
                        <div class="vessel-type">
                            <span class="vessel-type-label">ğŸš¢ è²¨æ«ƒèˆ¹</span>
                            <span class="vessel-type-value">${totalContainer.toLocaleString()}</span>
                        </div>
                        <div class="vessel-type">
                            <span class="vessel-type-label">â›´ï¸ æ•£è£èˆ¹</span>
                            <span class="vessel-type-value">${totalDryBulk.toLocaleString()}</span>
                        </div>
                        <div class="vessel-type">
                            <span class="vessel-type-label">ğŸ›³ï¸ é›œè²¨èˆ¹</span>
                            <span class="vessel-type-value">${totalGeneralCargo.toLocaleString()}</span>
                        </div>
                        <div class="vessel-type">
                            <span class="vessel-type-label">ğŸš— æ»¾è£èˆ¹</span>
                            <span class="vessel-type-value">${totalRoro.toLocaleString()}</span>
                        </div>
                        <div class="vessel-type">
                            <span class="vessel-type-label">ğŸ›¢ï¸ æ²¹è¼ª</span>
                            <span class="vessel-type-value">${totalTanker.toLocaleString()}</span>
                        </div>
                    `;

                    status.innerHTML = '<span class="success">âœ… è³‡æ–™è¼‰å…¥æˆåŠŸ</span>';
                } else {
                    dateInfo.innerHTML = '<span class="error">âŒ æ­¤æ—¥æœŸç¯„åœç„¡è³‡æ–™</span>';
                    document.getElementById('vessel-count').textContent = '0';
                    document.getElementById('avg-daily').textContent = '0';
                    document.getElementById('vessel-types').innerHTML = '';
                }

            } catch(e) {
                dateInfo.innerHTML = `<span class="error">âŒ è¼‰å…¥å¤±æ•—</span>`;
                status.innerHTML = `<span class="error">éŒ¯èª¤: ${e.message}</span>`;
                console.error('API Error:', e);
            }
        }
    </script>
</body>
</html>
